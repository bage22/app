<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/icons-extra.css" />
		<link rel="stylesheet" type="text/css" href="../css/app.css" />
		<script type="text/javascript" src="../js/bug.js"></script>
		<style type="text/css">
			#wypj {
				display: none;
			}
			img{
				width: 100%;
			}
		</style>
	</head>

	<body id="activity_info">
		<header class="mui-bar mui-bar-nav head_bg">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color_f"></a>
			<h1 class="mui-title color_f">
				活动详情
			</h1>
		</header>
		<div class="mui-content">
			<div id="hot_travel">
				<div class="hot_activity">
					<div class="hot_activity_img">
						<img id="gao" src="" />
						<p class="hot_activity_tit"><span class="fl"></span><span class="fr">&yen;<span class="price"></span></span>
						</p>
					</div>
					<div class="hot_activity_info">
						<span class="" style="float: right;margin-right: 20px;font-size: 12px;color:#8f8f94 ;line-height: 50px;"><span class="fr_people" style="font-size: 18px; color:#FEC900 ;"></span>人已参加</span>
						<p style="color: #333;display: inline;" class="subtitle"></p>
						<p class="biaoqian"><span class="fl" style="color: #FEC900;"><a href="javascript:void(0)"></a>
						<!--<a href="javascript:void(0)" class="endtime">2017年12月12日</a></span>-->
						</p>
					</div>
				</div>
				<div class="travel_agency">
					<div class="travel_agency_name fl"><!--<span><img class="tr_avatar" src="../img/01home_17.png"/></span>--><span class="tr_name"></span></div>
					<p class="travel_agency_phone fr" id="tel"><span class="mui-icon mui-icon-phone"></span>电话咨询</p>
					<input type="hidden" name="tr_phone" id="tr_phone" value="" />
				</div>
			</div>
			<div id="segmentedControl" class="mui-segmented-control">
				<a class="mui-control-item mui-active" href="#hdxq" data-id="0">
					活动详情
				</a>

				<a class="mui-control-item" href="#hdxz" data-id="2" id="tab_hdxz">
					活动须知
				</a>
			</div>
			<div class="hot_activity_text">
				<div class="mui-control-content mui-active hot_activity_panel" id="hdxq">
					<div class="panel_tit">
						<h4><span></span>活动详情</h4></div>
					<div class="panel_text">
						<!--<div class="panel_user">
				               <span class="user_img"><img class="image" src="../img/01home_28.png"/></span></span>
				               <span class="user_name">小猪快跑</span>
				          </div>-->
						<div class="panel_info">
							<ul class="hot_list">
								<li><span class="item_span"></span></li>
							</ul>
						</div>
					</div>
				</div>
				<div class="mui-control-content" id="hdxz">
					<div class="hot_activity_panel">
						<div class="panel_tit">
							<h4><span></span>活动须知</h4></div>
						<div class="panel_text">
							<div class="panel_info" id="hdxz_info">
								<p></p>
								<!--<p class="block">***卖家的服务态度挺好的，我买了之后还提醒我，认真检查下商品。真的不错，下次还在这买。</p>
					                <p class="block">服务态度挺好的，我买了之后还提醒我，认真检查下商品。真的不错，下次还在这买。</p>
					                <p>***卖家的服务态度挺好的，我买了之后还提醒我，认真检查下商品。真的不错，下次还在这买。</p>
					                <p>服务态度挺好的，我买了之后还提醒我，认真检查下商品。真的不错，下次还在这买。</p>
					                <p>***卖家的服务态度挺好的，我买了之后还提醒我，认真检查下商品。真的不错，下次还在这买。</p>
					                <p>服务态度挺好的，我买了之后还提醒我，认真检查下商品。真的不错，下次还在这买。</p>-->
							</div>
							<!--<div class="look_gd" id="lookGd"><span class="look_gd_text">查看更多</span><span class="mui-icon mui-icon-arrowright"></span></div>-->
						</div>
					</div>
					<div class="hot_activity_panel">
						<div class="panel_tit">
							<h4><span></span>退改规则</h4></div>
						<div class="panel_text">
							<div class="panel_info_txt">
								<p></p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="footer">
			<!--<div class="footer_count"><span class="times">2</span>期剩余<span class="chances">123</span>人次</div>-->
			<div class="footer_btn" id="enrolls" style="text-align: center;width: 100%;">
				<span class="btn_bm" style="width: 96%;">报名已满</span>
			</div>
		</div>

		<script src="../js/jquery-1.11.3.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/request.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/template.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/mui.min.js"></script>
		<!--<script src="../js/tokenyanzheng.js"></script>-->
		<script src="../js/sub.js" type="text/javascript" charset="utf-8"></script>
		<script>
			var hdid;
			var hdmc;
			var hdnr;
			var flag;
			var gname;
			var gprice;
			var gimg;
			
			var peoplenum;
			var people;
			var hdId;
			window.addEventListener('fanhui',function(){
				mui.toast('报名成功');
				mui.back();
			})
			mui.init({
				 beforeback: function() {
			　　　　 //获得父页面的webview
			        var list = plus.webview.currentWebview().opener();
			　　　　 //触发父页面的自定义事件(refresh),从而进行刷新
			        mui.fire(list, 'shuaxin');
			        //返回true,继续页面关闭逻辑
			        return true;
			    }
			});
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				var listid = self.listid; //获得列表页传过来的id
				hdid = listid;
				console.log(listid+"==="+localStorage.getItem('token'))
				//活动详情接口
				mui.ajax({
					url: WEB_HOST + "/activity/hddetail",
					type: "get",
					async: false,
					data: {
						"activityid": listid,
						'token':localStorage.getItem('token'),
					},
					dataType: "json",
					timeout: 1000,
					success: function(data) {
						hdId = data.data.id;
						peoplenum = data.data.peoplenum;
						people = data.data.people;
						console.log("====?====="+JSON.stringify(data));
						var ts = data.message.replace(/\[|]/g,'');
						if(data.status2 === "1") {
							flag = ts;
						} 
						if(data.status == 0) {
							flag = ts;
							$(".btn_bm")[0].innerHTML = flag;
							if(flag == "取消报名") {
								$("#wypj").css("display", "inline-block");
							}
						}
						gimg = data.data.image;
						gname = data.data.title;
						gprice = data.data.price;
						$(".hot_activity_img img").attr("src", data.data.image);
						$(".hot_activity_tit .fl").html(data.data.title);
						hdmc = data.data.title;
						$(".hot_activity_tit .price").html(data.data.price);
						$(".fr_people").html(data.data.people);
						$(".subtitle").html(data.data.subtitle);
						$(".endtime").html(data.data.endtime);
						//							$(".tr_avatar").attr("src",data.data.image);
						$(".tr_name").html(data.data.NAME);
						$("#tr_phone").val(data.data.phone);
						//							$(".user_img .image").attr("src",data.data.data.business.avatar);
						//							$(".user_name").html(data.data.data.business.name);
						$(".item_span").html(data.data.description);//图片有问题
						hdnr = data.data.description;
						$(".footer_count .times").html(data.data.times);
						$(".footer_count .chances").html(data.data.chances);
						$('.biaoqian .fl').text(data.data.endtime)
						/*解决页面 图片过大 撑出整个页面*/
						var is=document.images;
						for(var i=0,len=is.length;i<len;i++){
							is[i].style.cssText=""
						}
						/*解决页面 图片过大 撑出整个页面*/
					},
					error: function(a, b, c) {
						console.log(c);
					}
				});
				//				活动须知
				document.getElementById("tab_hdxz").addEventListener("tap", function() {
					mui.ajax({
						url: WEB_HOST + "/activity/hdxz",
						type: "get",
						async: false,
						data: {
							"activityid": listid,
							"token": localStorage.getItem("token")
						},
						dataType: "json",
						timeout: 1000,
						success: function(data) {
							if(data.status == 0) {
								$("#hdxz_info p").html(data.data.hdxz);
								$(".panel_info_txt p").html(data.data.tggz)
							}
						},
						error: function(a) {
							mui.toast("服务器未响应，请稍后重试");
						}
					});
				})
				document.getElementById("tel").addEventListener('tap', function() {
					plus.device.dial($("#tr_phone").val());
				});
				
				
//              报名 和 取消报名
				document.getElementById("enrolls").addEventListener('tap', function() {
					if(localStorage.getItem("token")) {
						if(flag == "取消报名") {
							var btnArray = ['否', '是'];
							mui.confirm(
								'确定取消报名？', 
								'提示', 
								btnArray,
								function(e) {
									if (e.index == 1) {
										mui.ajax({
											url: WEB_HOST + "/activity/bmActivity",
											type: "post",
											async: false,
											data: {
												"token": localStorage.getItem("token"),
												"hdid": hdid,
												"status": 1 //取消报名=2 立即报名=1
											},
											dataType: "json",
											timeout: 1000,
											success: function(data) {
												mui.toast(data.message);
												mui.back();
												mui.toast("取消报名成功")
											},
											error: function(a) {
												mui.toast("服务器未响应，请稍后重试");
											}
										});
									}
								})
//							
						} else if(flag === "立即报名") {
							mui.ajax({
								url:WEB_HOST + '/userCenter/yanzhengmy2',
								data:{
									'token':localStorage.getItem('token'),
								},
								dataType:'json',//服务器返回json格式数据
								type:'post',//HTTP请求类型
								timeout:10000,//超时时间设置为10秒；
								success:function(data){
									//console.log("============>"+JSON.stringify(data));//status:0,需要完善 1,不需要完善
									if(data.status==='0'){
										mui.openWindow({url:'add_lianxiren.html',id:'add_lianxiren',extras:{name:'wanshan',peoplenum:peoplenum,people:people}})
									}else{
										mui.openWindow({url:'lianxiren.html',id:'lianxiren',extras:{name:'baoming',hdId:hdId,peoplenum:peoplenum,people:people}})
									}
								},
								error:function(xhr,type,errorThrown){
									console.log(errorThrown);
								}
							});
							



//							mui.ajax({
//								url: WEB_HOST + "/activity/bmActivity",
//								type: "post",
//								async: false,
//								data: {
//									"token": localStorage.getItem("token"),
//									"hdid": hdid,
//									"status": 2 //取消报名=2 立即报名=1
//								},
//								dataType: "json",
//								timeout: 1000,
//								success: function(data) {
//									mui.toast(data.message);
//									mui.back();
//								},
//								error: function(a) {
//									mui.toast("服务器未响应，请稍后重试");
//								}
//							});
						}else if(flag === "报名已满"){
							var btnArray = ['是', '否'];
							mui.confirm("未登录，现在是否去登录", function(e) {
								if(e.index == 0) {
									mui.openWindow({
										url: "login.html",
										id: "login",
										createNew: true,
										waiting: {
											autoShow: true
										},
										show: {
											aniShow: 'none'
										}
									});
								}
							})
						}
					} else {
						var btnArray = ['是', '否'];
						mui.confirm("未登录，现在是否去登录", function(e) {
							if(e.index == 0) {
								mui.openWindow({
									url: "login.html",
									id: "login",
									createNew: true,
									waiting: {
										autoShow: true
									},
									show: {
										aniShow: 'none'
									}
								});
							}
						})
					}
				});
			})
		</script>
	</body>

</html>