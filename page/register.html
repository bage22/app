<!DOCTYPE html>
<html class="ui-page-login">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.css"/>
		<link rel="stylesheet" type="text/css" href="../css/mui.dtpicker.css"/>
		<link rel="stylesheet" type="text/css" href="../css/global.css"/>
		<link href="../css/register.css" rel="stylesheet" />
		<style type="text/css">
			#lookinput{
				vertical-align: middle;
				margin-right: 5px;
			}
			#select_sex {
				color: #666;
				font-size: 14px;
				
			}
			#select_sex option{
				text-align: right;
			}
			.sex.mui-navigate-right:after{
				right: 0px;
			}
		</style>
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color_b"></a>
			<h1 class="mui-title">注册</h1>
			<a class="mui-icon mui-pull-right" id="yyzh" style="font-size: 14px;margin-top: 6px;">已有账号</a>
		</header>
		<div class="mui-content">
			<form class="mui-input-group">
				<div class="mui-input-row">
					<label>账号</label>
					<input id='account' type="text" class="mui-input-clear mui-input" placeholder="请输入手机号">
					<!--<span id="send" class="mui-icon mui-icon-closeempty">发送</span>-->
				</div>
				<div class="mui-input-row">
					<label>密码</label>
					<input id='password' type="password" class="mui-input-clear mui-input" placeholder="请输入密码">
					<!--<span class="mui-icon mui-icon-checkmarkempty"></span>-->
				</div>
				<div class="mui-input-row">
					<label>确认密码</label>
					<input id='password_confirmation' type="password" class="mui-input-clear mui-input" placeholder="请再次输入密码">
					<!--<span class="mui-icon gth">!</span>-->
				</div>
				<div class="mui-input-row">
					<label>昵称</label>
					<input id='username' type="text" class="mui-input-clear mui-input" placeholder="请输入昵称">
					<!--<span id="send" class="mui-icon mui-icon-closeempty">发送</span>-->
				</div>
				
				<div class="mui-input-row">
					<label class="sex mui-navigate-right" href="#">性别</label>
					<select name="select" id="select_sex" >
						<option value="1" selected="true">男</option>
						<option value="2">女</option>
					</select>
			   </div>
				
				<div class="mui-input-row" style="position: relative;">
					<label>生日</label>
					<input name="birthday" disabled="disabled"  id="birthday" type="text" class="mui-input-clear mui-input" placeholder="">
				    <span data-options='{"type":"date","beginYear":1900,"endYear":2018}' id="select_bir" style="font-size:14px;position: absolute;right: 15px;top:6px;color: #aaa;">请选择</span>
				</div>
				<div class="mui-input-row">
					<label>验证码</label>
					<input id='code' type="email" class="mui-input-clear mui-input" placeholder="请输入验证码">
					<span class="mui-icon"><button type="button" id="send" class="mui-btn mui-btn-warning">发送验证码</button></span>
				</div>
			</form>
			<div class="information_message"></div>
			<div class="mui-content-padded">
				<button type="button" id="next" class="mui-btn mui-btn-primary mui-btn-block mui-btn-outlined">同意以下协议并注册</button>
			</div>
			<div class="mui-content-padded algin_cen">
				<p id="look"><span><input type="checkbox" name="look" id="lookinput" value="1" /></span>我已阅读<a href="javascript:void(0);" id="tiaokuan">xxx条款</a></p>
			</div>
		</div>
		<script src="../js/jquery-1.11.3.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/request.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/mui.min.js"></script>
	    <script src="../js/mui.picker.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/mui.dtpicker.js" type="text/javascript" charset="utf-8"></script>
		<script>
		      mui.init();
		      mui.plusReady(function(){
		      	document.getElementById("tiaokuan").addEventListener('tap',function(){
		           mui.openWindow({
		               url:"xieyi.html",
		               id:"xieyi"	
	       			});
		        });
		      	   //返回回来要执行的方法   
                function fun1(e){   
                    var val=e.detail.flag   
                    if(val==1){
                    	 document.getElementById("lookinput").checked=true;
                    }else{
                    	document.getElementById("lookinput").checked=false;
                    }
                }
                //自定义窗体事件  doit 要和b页面定义的 事件名称一致   
                window.addEventListener('doit',fun1); 
		      	(function($) {
				   	document.getElementById("select_bir").addEventListener("tap",function(){
				    	var optionsJson = this.getAttribute('data-options') || '{}';
								var options = JSON.parse(optionsJson);
								var id = this.getAttribute('id');
								/*
								 * 首次显示时实例化组件
								 * 示例为了简洁，将 options 放在了按钮的 dom 上
								 * 也可以直接通过代码声明 optinos 用于实例化 DtPicker
								 */
								var picker = new $.DtPicker(options);
								picker.show(function(rs) {
									/*
									 * rs.value 拼合后的 value
									 * rs.text 拼合后的 text
									 * rs.y 年，可以通过 rs.y.vaue 和 rs.y.text 获取值和文本
									 * rs.m 月，用法同年
									 * rs.d 日，用法同年
									 * rs.h 时，用法同年
									 * rs.i 分（minutes 的第二个字母），用法同年
									 */
		//							$("#birthday").val(rs.text);
		                            document.getElementById("birthday").value=rs.text;
		                            document.getElementById("select_bir").innerHTML="";
									/* 
									 * 返回 false 可以阻止选择框的关闭
									 * return false;
									 */
									/*
									 * 释放组件资源，释放后将将不能再操作组件
									 * 通常情况下，不需要示放组件，new DtPicker(options) 后，可以一直使用。
									 * 当前示例，因为内容较多，如不进行资原释放，在某些设备上会较慢。
									 * 所以每次用完便立即调用 dispose 进行释放，下次用时再创建新实例。
									 */
									picker.dispose();
								});
				    })
				})(mui);
		        document.getElementById("yyzh").addEventListener('tap',function(){
		           mui.openWindow({
		               url:"login.html",
		               id:"login",
		               createNew:true
	       			});
		        });
//		        document.getElementById("look").addEventListener('tap',function(){
//		           document.getElementById("states").value=1;
//		        });
                document.getElementById("lookinput").addEventListener("change",function(){
                	if(this.checked==true){
                		this.value=1;
                	}else{
                		this.value="";
                	}
                })
                $("#account").blur(function(){
                	var lens=$("#account").val().length;
                	if(lens!=11){
                		$(".information_message").html("请输入正确的手机号");
                		$("#account").focus();
                	}else{
                		$(".information_message").html("手机号符合");
                	}
                })
                $("#password").blur(function(){
                	var lens=$("#password").val().length;
                	if(lens<6){
                		$(".information_message").html("请输入正确的密码长度，至少6个字符，最多24个字符");
                		$("#password").focus();
                	}
                })
                $("#password_confirmation").blur(function(){
                	var pass1=$("#password").val();
                	var pass2=$("#password_confirmation").val();
                	if(pass2!=pass1){
                		$(".information_message").html("两次密码不一致");
                		$("#password").focus();
                	}else{
                		$(".information_message").html("密码格式正确");
                	}
                })
                $("#username").blur(function(){
                	var username=$("#username").val();
                	if(username==""){
                		$(".information_message").html("昵称不能为空");
                		$("#username").focus();
                	}
                })
		        document.getElementById("send").addEventListener('tap',function(){
		        	mui.ajax({
						url: WEB_HOST+"/auth/code/send", 
						type: "post",
						async: false,
						data: {
							"phone":$("#account").val()
						},
						dataType: "json",
						timeout: 1000,
						success: function(data) {
							if(data.status == 0){
								localStorage.setItem("phone",$("#account").val());
								 mui.toast(data.message);
								 retrieve();
							}else{
								mui.toast(data.message);
								document.getElementsByClassName("information_message")[0].innerHTML=data.message;
							}
						},error:function(a){
							mui.toast("服务器未响应，请稍后重试");
						}
					});
		        });
                var sex;
		        document.getElementById("next").addEventListener('tap',function(){
		        	sex=$("#select_sex").val();
			   	       if(sex=="男"){
			   	       	  sex=1;
			   	       }else if(sex=="女"){
			   	       	  sex=2;
			   	       }
		        	if($("#account").val()==""){
		        		mui.toast("请输入手机号");
                		$("#account").focus();
		        	}else if($("#username").val()==""){
		        		mui.toast("请输入昵称");
                		$("#username").focus();
		        	}else if($("#code").val()==""){
		        		mui.toast("请输入验证码");
                		$("#code").focus();
		        	}else{
		        		mui.ajax({
						url:WEB_HOST+"/auth/regist", 
						type: "post",
						async: false,
						data: {
							"phone":$("#account").val(),
							"password":$("#password").val(),
							"password_confirmation":$("#password_confirmation").val(),
							"username":$("#username").val(),
							"code":$("#code").val(),
							"birthday":$("#birthday").val(),
							"sex":sex,
							"protocol":$("#lookinput").val()
						},
						dataType: "json",
						timeout: 1000,
						success: function(data) {
							if(data.status == 0){
								localStorage.setItem("token",data.data.token);
								mui.openWindow({
									url: "login-successful.html",
									id: "login-successful",
									createNew:true,
									waiting: { 
										autoShow: true
									},show: {
										aniShow: 'none'
									}
								});
							}else if(data.status){
								mui.toast(data.message);
								document.getElementsByClassName("information_message")[0].innerHTML=data.message;
							}
						},
						error:function(a){
							mui.toast("服务器未响应，请稍后重试");
						}
					});
		        	}
		        });
		        
			        //			倒计时代码
			    function retrieve(){
			
				 	 var clock = '';
					 var nums = 59;
					 clock = setInterval(doLoop, 1000); //一秒执行一次
					function doLoop(){

						nums--;
						if(nums > 0){
						   if(nums<10){
						   	 document.getElementById("send").innerHTML=nums+'s后 重新发送';
						   }else if(nums>10){
						   	document.getElementById("send").innerHTML=nums+'s后 重新发送';
						   }
						}else{
						  clearInterval(clock); //清除js定时器
						  document.getElementById("send").innerHTML='<a onclick="cxhq();" class="color_f" href="javascript:void(0)">重新获取</a>';
						  nums = 59; //重置时间
						}
					 }
				}
	
	//			 重新获取并发送验证码
	             function cxhq(){
	             	mui.ajax({
							url: WEB_HOST+"/auth/code/send", 
							type: "post",
							async: false,
							data: {
								"phone":phone
							},
							dataType: "json",
							timeout: 1000,
							success: function(data) {
	                              mui.toast(data.message);
							}
						});
	             	retrieve();
	             }
		      })
 		</script>
	</body>

</html>